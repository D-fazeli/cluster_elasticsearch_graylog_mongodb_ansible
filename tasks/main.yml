---
- block:
  -  name: --- bind elasticsearch ip to hostname /etc/hosts ---
     lineinfile:
       dest: /etc/hosts
       state: present
       line: "{{ item.value.internal_ip }} {{ item.value.hostname }}{{ item.value.id }}"
     with_dict: "{{ elasticsearch_nodes }}"
     
        
  -  name: --- bind garylog ip to hostname /etc/hosts ---
     lineinfile:
       dest: /etc/hosts
       state: present
       line: "{{ item.value.internal_ip }} {{ item.value.hostname }}{{ item.value.id }}"
     with_dict: "{{ graylog_nodes }}"
     

  -  name: --- bind mongodb ip to hostname /etc/hosts ---
     lineinfile:
       dest: /etc/hosts
       state: present
       line: "{{ item.value.internal_ip }} {{ item.value.hostname }}{{ item.value.id }}"
     with_dict: "{{ mongodb_nodes }}"
     
        
  - name: --- mv old repo ---
    shell: |
       mkdir /etc/yum.repos.d/old_repo
       cd /etc/yum.repos.d/
       mv `ls -p | grep -v \/` old_repo/
    when: "{{ general_config.createRepo }}"
    ignore_errors: true   
    tags:
       - repo

  #- name: --- config repository All Package ---
  #  copy:
  #    dest: "/etc/yum.repos.d/all-packge.repo"
  #    content: |
  #       [all-package]
  #       name= all_package
  #       baseurl={{ general_config.url_repo1 }}
  #       gpgcheck=0
  #       enabled=1
  #       
  #- name: --- config repository Graylog Package ---
  #  copy:
  #    dest: "/etc/yum.repos.d/graylog.repo"
  #    content: |
  #       [graylog]
  #       name= graylog
  #       baseurl={{ general_config.url_repo2 }}
  #       gpgcheck=0
  #       enabled=1
  - name: -- craete file repository ---
    shell: touch /etc/yum.repos.d/{{ general_config.RepoFileName }}.repo
    when: "{{ general_config.createRepo }}"
    tags:
        - repo

  - name: --- config repository ---
    lineinfile:
       dest: "/etc/yum.repos.d/{{ general_config.RepoFileName }}.repo"
       line: |
         [{{ item.value.title_repo}}]
         name= {{ item.value.name }}
         baseurl= {{ item.value.baseurl }}
         gpgcheck= {{ item.value.gpgcheck }}
         enabled= {{ item.value.enable }}
    with_dict: "{{ repository }}"
    when: "{{ general_config.createRepo }}"
    tags:
        - repo      

  - name: --- refresh repolist ---
    shell: |
       yum clean all
       rm -fr /var/cache/yum/
    when: "{{ general_config.createRepo }}"
     
  - name: --- Setup OS Parameters (sysctl.conf)----
    blockinfile:
      path: /etc/sysctl.conf
      marker: "#-----------------"
      insertafter: '### AFTER THIS LINE'
      state: present
      block: |
        fs.file-max=512000
        vm.max_map_count=262144

  - name: --- Setup OS Parameters (limits.conf)----
    blockinfile:
      path: /etc/security/limits.conf
      marker: "#-----------------"
      insertafter: '### AFTER THIS LINE'
      state: present
      block: |
        elasticsearch       -       nofile          512000
        elasticsearch       -       memlock         unlimited

  - name: --- disable firewalld ------
    shell: |
      systemctl stop firewalld
      
  - include: java.yml
    when: "{{general_config.install_java}}"
    tags:
      - install_java
      
  - include: mongodb-install.yml
    when: "{{ general_config.install_mongodb }}"
    tags:
      - install_mongodb

  - include: elasticsearch-install.yml
    when: "{{ general_config.install_elasticsearch }}"
    tags:
      - install_elasticsearch

  - include: graylog-install.yml
    when: "{{ general_config.install_graylog }}"
    tags: 
      - install_graylog
  become: yes

